<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Schl√ºsselverwaltung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MSAL f√ºr Microsoft Login / Tokens -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <!-- React & ReactDOM √ºber CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel, damit wir JSX im Browser nutzen k√∂nnen -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root {
      --bg: #f4f5f7;
      --primary: #1f6feb;
      --primary-light: #e1ecff;
      --border: #d0d7de;
      --text: #111827;
      --muted: #6b7280;
      --danger: #dc2626;
      --radius-lg: 14px;
      --radius-xl: 18px;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.06);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e0edff, #f9fafb 40%);
      color: var(--text);
    }

    .app-root {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      gap: 16px;
    }

    .app-title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      background: var(--primary-light);
      color: var(--primary);
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
    }

    .user-info {
      font-size: 13px;
      text-align: right;
      color: var(--muted);
    }

    .user-info strong {
      display: block;
      color: var(--text);
    }

    .card {
      background: #ffffffcc;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(209, 213, 219, 0.6);
      padding: 18px 20px;
      backdrop-filter: blur(8px);
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .tab-btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      background: transparent;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tab-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }

    .tab-btn:not(.active):hover {
      background: #e5e7eb;
    }

    .pill {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.7);
      color: var(--primary);
      border: 1px solid rgba(209, 213, 219, 0.8);
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .dashboard-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--muted);
    }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }

    .btn:hover { filter: brightness(0.97); }

    .btn-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid currentColor;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    @media (max-width: 900px) {
      .dashboard-cards {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .dashboard-cards {
        grid-template-columns: minmax(0, 1fr);
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .user-info { text-align: left; }
    }

    .stat-card {
      border-radius: 16px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      background: linear-gradient(135deg, #ffffff, #f3f4ff);
      padding: 10px 12px;
    }

    .stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .stat-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .stat-value.danger { color: var(--danger); }

    .filters-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      align-items: center;
    }

    .input,
    .select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 10px;
      font-size: 13px;
      background: white;
      min-width: 140px;
    }

    .input::placeholder { color: #9ca3af; }

    .table-wrapper {
      border-radius: 14px;
      border: 1px solid rgba(209, 213, 219, 0.8);
      overflow: hidden;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead { background: #f3f4f6; }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    tbody tr:hover { background: #f9fafb; }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 11px;
      color: var(--muted);
    }

    .layout-2col {
      display: grid;
      grid-template-columns: 2fr 1.3fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .layout-2col {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .form-group { margin-bottom: 10px; }

    .form-label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
      color: #374151;
    }

    .form-help {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    textarea {
      width: 100%;
      min-height: 70px;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 13px;
      resize: vertical;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .section-sub {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .signatures {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 640px) {
      .signatures {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .signature-card {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 8px;
    }

    .signature-name {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .signature-role {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .signature-canvas-wrapper {
      border-radius: 10px;
      border: 1px dashed #cbd5f5;
      background: white;
      overflow: hidden;
      position: relative;
    }

    canvas.signature-canvas {
      width: 100%;
      height: 140px;
      display: block;
      touch-action: none;
      cursor: crosshair;
    }

    .signature-toolbar {
      display: flex;
      justify-content: space-between;
      padding: 4px 4px 0;
      font-size: 11px;
      color: var(--muted);
      align-items: center;
      gap: 4px;
    }

    .btn-ghost {
      border: none;
      background: transparent;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
      color: var(--muted);
    }

    .btn-ghost:hover { background: #e5e7eb; }

    .footer-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 11px;
      color: var(--muted);
      background: #f9fafb;
    }

    .empty-state {
      padding: 12px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div id="root" class="app-root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // -----------------------------------------------------------
    // OneDrive / Graph: Daten aus Personal.txt + Excel laden
    // -----------------------------------------------------------

    // TODO: HIER eure echten IDs eintragen:
    const msalConfig = {
      auth: {
        clientId: "DEINE_CLIENT_ID_AUS_AZURE_AD", // z.B. 12345678-abcd-...
        authority: "https://login.microsoftonline.com/DEINE_TENANT_ID", // z.B. 11111111-2222-...
        redirectUri: window.location.origin,
      },
    };

    const loginRequest = {
      scopes: [
        "User.Read",
        "Files.Read",
        "Files.Read.All",
      ],
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    async function getGraphClient() {
      let account = msalInstance.getActiveAccount();
      if (!account) {
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
          account = accounts[0];
        }
      }

      if (!account) {
        const loginResult = await msalInstance.loginPopup(loginRequest);
        account = loginResult.account;
      }

      msalInstance.setActiveAccount(account);

      const tokenResponse = await msalInstance.acquireTokenSilent({
        ...loginRequest,
        account,
      });

      const accessToken = tokenResponse.accessToken;

      const graphClient = {
        async get(url, responseType = "json") {
          const res = await fetch("https://graph.microsoft.com/v1.0" + url, {
            headers: { Authorization: "Bearer " + accessToken },
          });
          if (!res.ok) {
            throw new Error("Graph-Fehler " + res.status + ": " + (await res.text()));
          }
          if (responseType === "text") return res.text();
          return res.json();
        },
      };

      return { graphClient, account };
    }

    async function loadEmployeesFromPersonalTxt(graphClient) {
      const path = "/me/drive/root:/SchluesselAusgabe/Personal.txt:/content";
      const content = await graphClient.get(path, "text");

      const lines = content.split(/\\r?\\n/);
      const employees = [];
      let idCounter = 1;

      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;
        const parts = trimmed.split(";");
        if (parts.length < 2) continue;
        const personnelNumber = parts[0].trim();
        const fullName = parts[1].trim();
        employees.push({
          employeeId: "e" + idCounter++,
          personnelNumber,
          fullName,
          department: null,
        });
      }
      return employees;
    }

    async function loadExcelIssues(graphClient) {
      // TODO: Tabellenblatt-Namen ggf. anpassen ("Tabelle1")
      const excelBasePath =
        "/me/drive/root:/SchluesselAusgabe/Schl√ºssel Schlie√üplan Verteilung Mitarbeiter.xlsx";
      const rangeUrl =
        excelBasePath + ":/workbook/worksheets('Tabelle1')/usedRange(valuesOnly=true)";
      const json = await graphClient.get(rangeUrl, "json");

      const rows = json.values;
      if (!rows || rows.length === 0) return [];

      const header = rows[0].map((h) => String(h).trim());
      const dataRows = rows.slice(1);

      const indexOf = (name) => header.findIndex((h) => h === name);

      const idxAbteilung = indexOf("Abteilung");
      const idxPersonalnr = indexOf("Personalnummer");
      const idxName = indexOf("Name");
      const idxSystem = indexOf("Schlie√üsystem");
      const idxWeitere = indexOf("weitere Schl√ºssel");
      const idxDatum = indexOf("Datum");
      const idxRueckgabe = indexOf("R√ºckgabe");

      const issues = [];
      let i = 1;

      for (const row of dataRows) {
        if (!row || row.length === 0) continue;
        const value = (idx) =>
          idx >= 0 && idx < row.length && row[idx] != null && row[idx] !== ""
            ? String(row[idx]).trim()
            : null;

        const department = value(idxAbteilung);
        const pnRaw = value(idxPersonalnr);
        const name = value(idxName);
        const system = value(idxSystem);
        const otherKeys = value(idxWeitere);
        const dateVal = value(idxDatum);
        const rueckgabe = value(idxRueckgabe);

        let issueDate = dateVal || null;
        const hasReturn = !!rueckgabe;
        const returnInfo = rueckgabe || null;

        let personnelNumber = pnRaw;
        if (pnRaw && /^\\d+\\.0$/.test(pnRaw)) {
          personnelNumber = String(parseInt(pnRaw, 10));
        }

        issues.push({
          id: i++,
          employeeName: name,
          personnelNumber,
          department,
          system,
          otherKeys,
          issueDate,
          hasReturn,
          returnInfo,
        });
      }
      return issues;
    }

    function buildKeysFromIssues(issues) {
      const systems = new Set();
      for (const i of issues) {
        if (i.system) systems.add(i.system);
      }
      const keys = [];
      let idx = 1;
      for (const sys of Array.from(systems).sort()) {
        keys.push({
          keyId: "k" + idx++,
          system: sys,
          number: "",
          description: sys,
        });
      }
      return keys;
    }

    function mergeEmployees(employees, issues) {
      const byPn = new Map();
      const byName = new Map();

      for (const emp of employees) {
        if (emp.personnelNumber) byPn.set(emp.personnelNumber, emp);
        if (emp.fullName) byName.set(emp.fullName.toLowerCase(), emp);
      }

      for (const issue of issues) {
        const name = issue.employeeName;
        const pn = issue.personnelNumber;
        const dept = issue.department;

        let emp = null;
        if (pn && byPn.has(pn)) emp = byPn.get(pn);
        else if (name && byName.has(name.toLowerCase())) emp = byName.get(name.toLowerCase());

        if (!emp && (name || pn)) {
          emp = {
            employeeId: "e" + (employees.length + 1),
            personnelNumber: pn || null,
            fullName: name || null,
            department: dept || null,
          };
          employees.push(emp);
        }

        if (emp) {
          if (emp.personnelNumber && !byPn.has(emp.personnelNumber))
            byPn.set(emp.personnelNumber, emp);
          if (emp.fullName && !byName.has(emp.fullName.toLowerCase()))
            byName.set(emp.fullName.toLowerCase(), emp);
          if (dept && !emp.department) emp.department = dept;
        }
      }
      return employees;
    }

    async function fetchOneDriveData() {
      const { graphClient, account } = await getGraphClient();
      const [employeesFromTxt, issuesFromExcel] = await Promise.all([
        loadEmployeesFromPersonalTxt(graphClient),
        loadExcelIssues(graphClient),
      ]);

      const employees = mergeEmployees([...employeesFromTxt], issuesFromExcel);
      const keys = buildKeysFromIssues(issuesFromExcel);
      const issues = issuesFromExcel;

      return { employees, keys, issues, account };
    }

    // -----------------------------------------------------------
    // SignaturePad ‚Äì Canvas f√ºr Unterschrift (Maus/Touch)
    // -----------------------------------------------------------
    function SignaturePad({ value, onChange, label, role }) {
      const canvasRef = useRef(null);
      const drawing = useRef(false);
      const lastPos = useRef({ x: 0, y: 0 });

      useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;

        const resize = () => {
          const rect = canvas.getBoundingClientRect();
          const imageData = canvas.getContext("2d").getImageData(0, 0, canvas.width, canvas.height);
          canvas.width = rect.width;
          canvas.height = 140;
          canvas.getContext("2d").putImageData(imageData, 0, 0);
        };

        resize();
        window.addEventListener("resize", resize);
        return () => window.removeEventListener("resize", resize);
      }, []);

      const getPos = (e) => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        if (e.touches && e.touches.length > 0) {
          return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top,
          };
        } else {
          return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top,
          };
        }
      };

      const startDrawing = (e) => {
        e.preventDefault();
        drawing.current = true;
        lastPos.current = getPos(e);
      };

      const draw = (e) => {
        if (!drawing.current) return;
        e.preventDefault();
        const canvas = canvasRef.current;
        const ctx = canvas.getContext("2d");
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#111827";

        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(lastPos.current.x, lastPos.current.y);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        lastPos.current = pos;
      };

      const stopDrawing = () => {
        if (!drawing.current) return;
        drawing.current = false;
        const canvas = canvasRef.current;
        if (!canvas) return;
        const dataUrl = canvas.toDataURL("image/png");
        onChange && onChange(dataUrl);
      };

      const handleClear = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        onChange && onChange(null);
      };

      return (
        <div className="signature-card">
          <div className="signature-name">{label}</div>
          <div className="signature-role">{role}</div>
          <div className="signature-canvas-wrapper">
            <canvas
              ref={canvasRef}
              className="signature-canvas"
              onMouseDown={startDrawing}
              onMouseMove={draw}
              onMouseUp={stopDrawing}
              onMouseLeave={stopDrawing}
              onTouchStart={startDrawing}
              onTouchMove={draw}
              onTouchEnd={stopDrawing}
            />
          </div>
          <div className="signature-toolbar">
            <span>PC: Maus / Tablet ¬∑ iPad: Finger/Stift</span>
            <button type="button" className="btn-ghost" onClick={handleClear}>
              Leeren
            </button>
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------
    // Dashboard ‚Äì √úbersicht (nutzt issues-Prop)
    // -----------------------------------------------------------
    function Dashboard({ issues }) {
      const [collapsed, setCollapsed] = useState(false);
      const [search, setSearch] = useState("");
      const [department, setDepartment] = useState("");
      const [system, setSystem] = useState("");

      const outstanding = issues.filter((i) => !i.hasReturn);
      const departments = Array.from(
        new Set(outstanding.map((i) => (i.department || "").trim()).filter(Boolean))
      );
      const systems = Array.from(
        new Set(outstanding.map((i) => (i.system || "").trim()).filter(Boolean))
      );

      const filtered = outstanding.filter((i) => {
        let match = true;
        const term = search.toLowerCase();
        if (term) {
          match =
            (i.employeeName || "").toLowerCase().includes(term) ||
            (i.personnelNumber || "").toLowerCase().includes(term);
        }
        if (match && department) {
          match = (i.department || "").trim() === department;
        }
        if (match && system) {
          match = (i.system || "").trim() === system;
        }
        return match;
      });

      return (
        <div className="card">
          <div className="dashboard-header">
            <div>
              <div className="section-title">Dashboard</div>
              <div className="section-sub">
                √úbersicht √ºber aktuell ausgegebene Schl√ºssel (ohne erfasste R√ºckgabe).
              </div>
            </div>
            <div className="dashboard-actions">
              <button
                type="button"
                className="btn"
                onClick={() => setCollapsed(!collapsed)}
              >
                <span className="btn-icon">{collapsed ? "‚ñ∏" : "‚ñæ"}</span>
                Dashboard {collapsed ? "anzeigen" : "ausblenden"}
              </button>
            </div>
          </div>

          {!collapsed && (
            <>
              <div className="dashboard-cards">
                <div className="stat-card">
                  <div className="stat-label">Aktiv ausgegebene Schl√ºssel</div>
                  <div className="stat-value">{outstanding.length}</div>
                  <div className="stat-sub">ohne registrierte R√ºckgabe</div>
                </div>
                <div className="stat-card">
                  <div className="stat-label">Abteilungen</div>
                  <div className="stat-value">{departments.length}</div>
                  <div className="stat-sub">mit offenen Schl√ºsseln</div>
                </div>
                <div className="stat-card">
                  <div className="stat-label">Schlie√üsysteme</div>
                  <div className="stat-value">{systems.length}</div>
                  <div className="stat-sub">mit offenen Schl√ºsseln</div>
                </div>
              </div>

              <div className="filters-row">
                <input
                  className="input"
                  placeholder="Suche nach Name oder Personalnummer‚Ä¶"
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                />
                <select
                  className="select"
                  value={department}
                  onChange={(e) => setDepartment(e.target.value)}
                >
                  <option value="">Alle Abteilungen</option>
                  {departments.map((d) => (
                    <option key={d} value={d}>{d}</option>
                  ))}
                </select>
                <select
                  className="select"
                  value={system}
                  onChange={(e) => setSystem(e.target.value)}
                >
                  <option value="">Alle Schlie√üsysteme</option>
                  {systems.map((s) => (
                    <option key={s} value={s}>{s}</option>
                  ))}
                </select>
                <span className="chip">{filtered.length} Eintr√§ge gefunden</span>
              </div>

              <div className="table-wrapper">
                {filtered.length === 0 ? (
                  <div className="empty-state">
                    Keine offenen Schl√ºssel mit diesen Filtern gefunden.
                  </div>
                ) : (
                  <table>
                    <thead>
                      <tr>
                        <th>Mitarbeiter</th>
                        <th>Personalnr.</th>
                        <th>Abteilung</th>
                        <th>Schlie√üsystem</th>
                        <th>Weitere Schl√ºssel</th>
                        <th>Ausgabedatum</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filtered.map((row) => (
                        <tr key={row.id}>
                          <td>{row.employeeName}</td>
                          <td>{row.personnelNumber || "‚Äì"}</td>
                          <td>{(row.department || "").trim()}</td>
                          <td><span className="tag">{row.system || "n/a"}</span></td>
                          <td>{row.otherKeys || "‚Äì"}</td>
                          <td>{row.issueDate}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
            </>
          )}
        </div>
      );
    }

    // -----------------------------------------------------------
    // Formular: Schl√ºssel ausgeben ‚Äì nutzt employees & keys
    // -----------------------------------------------------------
    function IssueForm({ employees, keys }) {
      const [employeeSearch, setEmployeeSearch] = useState("");
      const [selectedEmployee, setSelectedEmployee] = useState(null);
      const [selectedKeyId, setSelectedKeyId] = useState("");
      const [comment, setComment] = useState("");
      const [issuedBySignature, setIssuedBySignature] = useState(null);
      const [receivedBySignature, setReceivedBySignature] = useState(null);

      const filteredEmployees = employees.filter((e) => {
        const term = employeeSearch.toLowerCase();
        if (!term) return true;
        return (
          (e.fullName || "").toLowerCase().includes(term) ||
          (e.personnelNumber || "").toLowerCase().includes(term)
        );
      });

      const handleSelectEmployee = (id) => {
        const emp = employees.find((e) => e.employeeId === id);
        setSelectedEmployee(emp || null);
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!selectedEmployee || !selectedKeyId || !issuedBySignature || !receivedBySignature) {
          alert("Bitte Mitarbeiter, Schl√ºssel und beide Unterschriften erfassen.");
          return;
        }

        const key = keys.find((k) => k.keyId === selectedKeyId);

        const payload = {
          employeeId: selectedEmployee.employeeId,
          personnelNumber: selectedEmployee.personnelNumber,
          employeeName: selectedEmployee.fullName,
          keyId: selectedKeyId,
          keySystem: key?.system,
          keyNumber: key?.number,
          keyDescription: key?.description,
          comment,
          issuedBySignatureBase64: issuedBySignature,
          receivedBySignatureBase64: receivedBySignature,
        };

        console.log("AUFGABE: an Backend senden /api/key-issues (ISSUE)", payload);
        alert("Demo: Schl√ºssel-Ausgabe wurde lokal protokolliert (siehe Browser-Konsole).");
      };

      return (
        <div className="card">
          <div className="section-title">Schl√ºssel ausgeben</div>
          <div className="section-sub">
            Erfasse die Ausgabe eines Schl√ºssels inklusive Unterschriften und √úbergabeprotokoll.
          </div>

          <form onSubmit={handleSubmit}>
            <div className="layout-2col">
              <div>
                <div className="form-group">
                  <label className="form-label">Mitarbeiter suchen</label>
                  <input
                    className="input"
                    placeholder="Name oder Personalnummer eingeben‚Ä¶"
                    value={employeeSearch}
                    onChange={(e) => setEmployeeSearch(e.target.value)}
                  />
                  <div className="form-help">
                    Stammdaten kommen aus Personal.txt + Excel (sp√§ter HR-App).
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">Mitarbeiter ausw√§hlen</label>
                  <select
                    className="select"
                    onChange={(e) => handleSelectEmployee(e.target.value)}
                    value={selectedEmployee?.employeeId || ""}
                  >
                    <option value="">Bitte ausw√§hlen‚Ä¶</option>
                    {filteredEmployees.map((e) => (
                      <option key={e.employeeId} value={e.employeeId}>
                        {e.fullName} ({e.personnelNumber})
                      </option>
                    ))}
                  </select>
                </div>

                {selectedEmployee && (
                  <>
                    <div className="form-group">
                      <label className="form-label">Abteilung</label>
                      <input
                        className="input"
                        value={selectedEmployee.department || ""}
                        readOnly
                      />
                    </div>
                    <div className="form-group">
                      <label className="form-label">Personalnummer</label>
                      <input
                        className="input"
                        value={selectedEmployee.personnelNumber || ""}
                        readOnly
                      />
                    </div>
                    <div className="form-group">
                      <label className="form-label">Name</label>
                      <input
                        className="input"
                        value={selectedEmployee.fullName || ""}
                        readOnly
                      />
                    </div>
                  </>
                )}

                <div className="form-group">
                  <label className="form-label">Schl√ºssel ausw√§hlen</label>
                  <select
                    className="select"
                    value={selectedKeyId}
                    onChange={(e) => setSelectedKeyId(e.target.value)}
                  >
                    <option value="">Bitte ausw√§hlen‚Ä¶</option>
                    {keys.map((k) => (
                      <option key={k.keyId} value={k.keyId}>
                        {k.system} {k.number ? "‚Äì " + k.number : ""} ({k.description})
                      </option>
                    ))}
                  </select>
                  <div className="form-help">
                    Pro physischem Schl√ºssel wird ein Datensatz gef√ºhrt (Schlie√üsystem + Nummer + Beschreibung).
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">Weitere Schl√ºssel / Bemerkungen</label>
                  <textarea
                    value={comment}
                    onChange={(e) => setComment(e.target.value)}
                    placeholder="Optionale Zusatzinformationen zur Ausgabe‚Ä¶"
                  />
                </div>
              </div>

              <div>
                <div className="section-title">Unterschriften</div>
                <div className="section-sub">
                  Beide Unterschriften werden im PDF-Protokoll gespeichert (PC & iPad geeignet).
                </div>
                <div className="signatures">
                  <SignaturePad
                    label="Ausgeh√§ndigt durch"
                    role="Mitarbeiter, der den Schl√ºssel √ºbergibt"
                    value={issuedBySignature}
                    onChange={setIssuedBySignature}
                  />
                  <SignaturePad
                    label="Empfangen durch"
                    role="Mitarbeiter, der den Schl√ºssel erh√§lt"
                    value={receivedBySignature}
                    onChange={setReceivedBySignature}
                  />
                </div>
              </div>
            </div>

            <div className="footer-actions">
              <button type="button" className="btn">Abbrechen</button>
              <button type="submit" className="btn btn-primary">
                Schl√ºssel-Ausgabe speichern &amp; PDF erzeugen
              </button>
            </div>
          </form>
        </div>
      );
    }

    // -----------------------------------------------------------
    // Formular: R√ºckgabe (nutzt issues-Prop)
    // -----------------------------------------------------------
    function ReturnForm({ issues }) {
      const [search, setSearch] = useState("");

      const outstanding = issues.filter((i) => !i.hasReturn);

      const filteredIssues = outstanding.filter((i) => {
        const term = search.toLowerCase();
        if (!term) return true;
        return (
          (i.employeeName || "").toLowerCase().includes(term) ||
          (i.personnelNumber || "").toLowerCase().includes(term)
        );
      });

      const handleReturn = (issue) => {
        console.log("AUFGABE: R√ºckgabe-Prozess starten f√ºr", issue);
        alert("Demo: Hier k√§me die R√ºckgabe mit Unterschriften & PDF-Erzeugung.");
      };

      return (
        <div className="card">
          <div className="section-title">R√ºckgabe erfassen</div>
          <div className="section-sub">
            Mitarbeiter verlassen das Unternehmen oder geben Schl√ºssel zur√ºck ‚Äì hier erfasst du die R√ºckgabe.
          </div>

          <div className="filters-row">
            <input
              className="input"
              placeholder="Mitarbeiter oder Personalnummer suchen‚Ä¶"
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
            <span className="chip">{filteredIssues.length} offene Ausgaben</span>
          </div>

          <div className="table-wrapper">
            {filteredIssues.length === 0 ? (
              <div className="empty-state">
                Keine offenen Schl√ºssel-Ausgaben mit diesen Suchkriterien.
              </div>
            ) : (
              <table>
                <thead>
                  <tr>
                    <th>Mitarbeiter</th>
                    <th>Personalnr.</th>
                    <th>Abteilung</th>
                    <th>Schl√ºssel / System</th>
                    <th>Weitere Schl√ºssel</th>
                    <th>Ausgabedatum</th>
                    <th>Aktion</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredIssues.map((i) => (
                    <tr key={i.id}>
                      <td>{i.employeeName}</td>
                      <td>{i.personnelNumber || "‚Äì"}</td>
                      <td>{(i.department || "").trim()}</td>
                      <td>{i.system || "n/a"}</td>
                      <td>{i.otherKeys || "‚Äì"}</td>
                      <td>{i.issueDate}</td>
                      <td>
                        <button
                          type="button"
                          className="btn"
                          onClick={() => handleReturn(i)}
                        >
                          R√ºckgabe erfassen
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        </div>
      );
    }

    // -----------------------------------------------------------
    // Haupt-App ‚Äì l√§dt Daten aus OneDrive
    // -----------------------------------------------------------
    function App() {
      const [activeTab, setActiveTab] = useState("dashboard");
      const [employees, setEmployees] = useState([]);
      const [keys, setKeys] = useState([]);
      const [issues, setIssues] = useState([]);
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        fetchOneDriveData()
          .then((data) => {
            setEmployees(data.employees);
            setKeys(data.keys);
            setIssues(data.issues);
            setUser(data.account);
          })
          .catch((err) => {
            console.error(err);
            setError("Fehler beim Laden der Daten aus OneDrive / Graph.");
          })
          .finally(() => setLoading(false));
      }, []);

      const displayName = user?.name || "Benutzer";
      const mail = user?.username || user?.email || "";

      if (loading) {
        return <div className="card">Daten werden aus OneDrive geladen‚Ä¶</div>;
      }

      if (error) {
        return <div className="card">‚ö† {error}</div>;
      }

      return (
        <>
          <header>
            <div className="app-title">
              üîë Schl√ºsselverwaltung
              <span className="badge">Intern</span>
            </div>
            <div className="user-info">
              <strong>{displayName}</strong>
              <span>{mail}</span>
              <span>Angemeldet √ºber Microsoft / Azure AD</span>
            </div>
          </header>

          <div className="card" style={{ marginBottom: 14 }}>
            <div className="tabs">
              <button
                className={"tab-btn " + (activeTab === "dashboard" ? "active" : "")}
                onClick={() => setActiveTab("dashboard")}
              >
                <span className="btn-icon">üìä</span>
                Dashboard
              </button>
              <button
                className={"tab-btn " + (activeTab === "issue" ? "active" : "")}
                onClick={() => setActiveTab("issue")}
              >
                <span className="btn-icon">‚ûï</span>
                Ausgabe
                <span className="pill">mit Unterschrift</span>
              </button>
              <button
                className={"tab-btn " + (activeTab === "return" ? "active" : "")}
                onClick={() => setActiveTab("return")}
              >
                <span className="btn-icon">‚Ü©</span>
                R√ºckgabe
              </button>
            </div>
          </div>

          {activeTab === "dashboard" && <Dashboard issues={issues} />}
          {activeTab === "issue" && <IssueForm employees={employees} keys={keys} />}
          {activeTab === "return" && <ReturnForm issues={issues} />}
        </>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
